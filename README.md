# fcx_ce

This repository is used to analyze cryptic exons (CEs) on sequencing reads from single 
cells. Specifically, sequencing reads are filtered by celltype and sample groups of 
interest, which were previously determined.

## Package installation

Packages are mainly managed using [Conda](https://docs.conda.io/projects/conda/en/stable/).
The current analysis uses two conda environments, as listed below:

- ``env``: Required for Snakemake. Refer to `env.archived.yaml` for packages used
in the current workflow.
- ``lcenv``: Required for downstream analysis using LeafCutter in R. Refer to 
`lcenv.archived.yaml` for packages used in this environment. Note that 
this environment includes pacckages installed in R, but there were not 
exported to the `lcenv.archived.yaml`.
- ``menv``: Required for downstream analysis without LeafCutter in R. Refer to
``menv.archived.yaml`` for packages used in this environment.

## Input datasets

Input to the current analysis consists of BAM files generated 
by [cellranger count](https://www.10xgenomics.com/support/software/cell-ranger/latest/tutorials/cr-tutorial-ct). 
Ensure the following files are prepared in the input directory.

- `possorted_genome_bam.bam`
- `possorted_genome_bam.bam.bai`

## Snakemake

The current analysis uses Snakemake, which runs each step in a pipeline. All commands and configurations
are designed to be executed within a Snakemake pipeline.

### Configuration

Configure analysis options using the `config.yaml` file, as demonstrated below:

#### Sampletable

The following keys are configured in the sampletable:

- Unique sample identifiers. Set the `index_col` option to this column in the following key.
- Paths to input BAM files. Set the `bam_col` option to this column in the following key.
- Optional metadata columns. 
    - Set the `key_col` option to a column you want to aggregate sequencing reads by. 
    This is typically a column for sample groups.
    - Set the `celltype_col` option to a column for celltype annotation.

```yaml

# Path to sampletable
sampletable: "path/to/metadata.csv"
```

#### Reference fasta

This is required to identify the strandness of sequencing reads when extracting
splicing junctions. Specify the reference fasta file you used to run 
``cellranger count``.

```yaml
fasta: "../../input/thalamus_excitatory/genome.fa"
```

#### Columns of interest

Your columns of interest in the sampletable are configured here. Refer to the 
following summary:

- `key_col`: Column for sample groups. Sequencing reads will be aggregated 
by sample group based on this column.
- `index_col`: Unique sample identifiers.
- `bam_col`: Paths to input BAM files. Ensure to use `possorted_genome_bam.bam` 
generated by `cellranger count`.
- `celltype_col`: Column for celltype annotation. Sequencing reads will be aggregated 
by celltype based on this column. Set this option to "" if you don't need celltype-
specific analysis.

```yaml

# Required column names
key_col: 'study_specific_disease_specific' # column for read aggregation
index_col: 'SampleID' # column for unique sample ID, aka index
bam_col: 'bam' # column for paths to bam files
celltype_col: 'celltype'  # column for celltype (leave '' to skip this option)
```

#### All metadata columns

Oftentimes, the input sampletable contains many columns that are not necessarily informative 
at this point. This key configures column names that will be filtered for the current analysis.
Columns that are unspecified in this key will be removed to keep the analysis concise.


```yaml

# Metadata column for aggregating reads
all_cols: 
  - 'status'
  - 'study'
  - 'Genetics'
  - 'AgeDeath'
  - 'Disease'
  - 'BrainRegion'
  - 'Sex'
  - 'general_disease'
  - 'study_disease'
  - 'study_specific_disease_specific'
```

#### Barcodes

Barcodes are required to filter celltypes of interest. Note that this workflow 
is designed to use the [*AnnData*](https://anndata.readthedocs.io/en/stable/)
object in Python as input material containing barcode information. Set the format to
`celltype: "path/to/anndata"`, as demonstrated below:

```yaml

# Path to AnnData
adata:
  ExNeu1: "../../input/thalamus_excitatory/ExNeu1_FOR_DEG.h5ad"
  ExNeu2: "../../input/thalamus_excitatory/ExNeu2_FOR_DEG.h5ad"
```

#### Paths to input and output directories

Set paths to directories containing input BAM files (`possorted_genome_bam.bam`) and all output files,
using the `bam_dir` and `outdir` keys.

```yaml

# Path to bam directory
bam_dir: '../../input/thalamus_excitatory/bam'

# Path to output directory
outdir: "results"
```

#### Genes of interest

Sequencing reads for genes of interest will retain in the output BAM file. Specify 
the `genes` key to your genes of interest.

```yaml

# Genes of interest
genes:
  - 'STMN2'
  - 'UNC13A'
```

#### Analysis name

This will be used as the prefix of the output file name for the junction count
matrix.

```yaml
analysis: 'thalamus_excitatory'
```

### Workflow

The current Snakemake pipeline is designed to return a count matrix for
splicing junctions by implementing the following rules:

### Pseudo-bulk mode (e.g. `workflow/thalamus_excitatory`)

- `create_header`: Checks whether all headers (`@SQ`) are identical across
the samples and creates a header sam file. The output of this rule is 
`<output_directory>/header.sam`.
- `prep_sam`: Extracts barcodes of interest from given `AnnData` objects 
and creates sam files containing filtered reads based on the extracted barcodes.
The output of this rule is `<output_directory>/sam/<sample>_<celltype>.sam`.
- `create_sample_celltype_bam`: Creates bam files by consolidating sam files (for
the header and filtered reads) by sample and celltype. The output of this rule is 
`<output_directory>/bam/sample/<sample>_<celltype>_sorted.bam`.
- `create_group_celltype_bam`: Creates bam files by consolidating sam files (for
the header and filtered reads) by group and celltype (e.g. disease, treatment, etc).
The output of this rule is `<output_directory>/bam/group/<group>_<celltype>_sorted.bam`.
- `extract_junctions`: Captures splicing junctions from filtered bam files using
[`regtools extract`](https://regtools.readthedocs.io/en/latest/commands/junctions-extract/).
The output of this rule is `<output_directory>/bed/sample/<sample>_celltype.junc`,
which is in the [bed12 format](https://genome.ucsc.edu/faq/faqformat.html#format1).
- `prep_juncfiles`: Creates a text file for paths to all input junction 
files. The output of this rule is `<output_directory>/juncfiles.txt`.
- `count_junctions`: Counts the number of junctions across the input samples or 
groups using leafcutter.


### Single-cell mode (e.g. `workflow/thalamus_sc`)

- `create_header`: Checks whether all headers (`@SQ`) are identical across
the samples and creates a header sam file. The output of this rule is 
`<output_directory>/header.sam`.
- `prep_bam`: Extracts barcodes of interest from given `AnnData` objects 
and creates sam and bam files containing filtered reads per barcode. The output of
this rule is `<output_directory>/bam/cell/<barcode>_sorted.bam`.
- `aggr_bams_group_celltype`: Merges single-cell bam files by group and celltype 
(e.g. disease, treatment, etc). The output of this rule is 
`<output_directory>/bam/group/<group>_<celltype>_sorted.bam`.
- `extract_junctions`: Captures splicing junctions from filtered bam files using
[`regtools extract`](https://regtools.readthedocs.io/en/latest/commands/junctions-extract/).
The output of this rule is `<output_directory>/bed/cell/<sample>_celltype.junc`,
which is in the [bed12 format](https://genome.ucsc.edu/faq/faqformat.html#format1).
- `prep_juncfiles`: Creates a text file for paths to all input junction 
files. The output of this rule is `<output_directory>/juncfiles.txt`.
- `count_junctions`: Counts the number of junctions across the barcodes
using leafcutter. The output junction-by-barcode count matrix is saved 
as `<output_directory>/junction_counts/<analysis_suffix>_perind_numbers.counts.gz`.

## Downstream analyses

Downstream analyses were performed on the junction count matrices generated by
the Snakemake pipeline.

### Single-cell exploratory analysis

- `workflow/thalamus_sc/downstream/sc-exploratory.Rmd`: Extracted junctions
were analyzed at the single-cell level. The analysis included QC,
the number/proportion of cells containing junctions with and without 
CE detection, the relationship between gene expression and CE detection,
and visualization of cells by junction type in a UMAP embedding.


### Differential analysis

- `workflow/thalamus_excitatory/downstream/ds.Rmd`: differential splicing analysis
comparing *patient vs control* and *ExNeu2 vs ExNeu1* using *LeafCutter* in R.
Refer to the following resources for more information about
*LeafCutter*: [Li et al., 2018](https://www.nature.com/articles/s41588-017-0004-9),
[LeafCutter Documentation](https://davidaknowles.github.io/leafcutter/index.html),
[LeafCutter GitHub](https://github.com/davidaknowles/leafcutter)

- `workflow/thalamus_sc/downstream/sc-pseudobulk.Rmd`: differential analysis
comparing *patient vs control* across per-study-per-celltype subsets,
using DESeq2. Refer to the following resources for details on DESeq2: 
[Love et al., 2013](https://doi.org/10.1186/s13059-014-0550-8), 
[DESeq2 Documentation](https://www.bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html)

- `workflow/thalamus_sc/downstream/sc-fisherexact.Rmd`: differential analysis
comparing *patient vs control* across per-study-per-celltype subsets,
using Fisher's exact test. This analysis was performed on a 2x2 contingency
table based on a binary matrix that consists of 1 if detected and 0 otherwise.

- `workflow/thalamus_sc/downstream/sc-pseudobulk-aggr.Rmd`: differential analysis
comparing *patient vs control* across per-study-per-celltype subsets,
using zinbwave-DESeq2 workflow. This analysis was performed on samples aggregated 
across all FTD and Control-FTD, respectively. Refer to the following resources 
for details on zinbwave: 
[Van den Berge et al., 2018](https://link.springer.com/article/10.1186/s13059-018-1406-4) ,
[Risso et al., 2018](https://www.nature.com/articles/s41467-017-02554-5),
[zinbwave-DESeq2 workflow](https://github.com/mikelove/zinbwave-deseq2/blob/master/zinbwave-deseq2.Rmd)
